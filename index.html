<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è³‡æ™‚è–ªå¸³æœ¬ v2.3 (åŠ ç­ç²¾ç®—ç‰ˆ) | WUCJ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0fdfa; }
        .locked input, .locked select { background-color: #e5e7eb; cursor: not-allowed; pointer-events: none; }
        .tab-active { border-bottom: 3px solid #0d9488; color: #0d9488; font-weight: bold; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-money { font-family: 'Courier New', Courier, monospace; font-weight: bold; }
    </style>
</head>
<body class="text-gray-700 pb-24">

<!-- å°èˆªåˆ— -->
<nav class="bg-white shadow-md p-3 sticky top-0 z-50 border-t-4 border-teal-600">
    <div class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-lg md:text-xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-book-open mr-2 text-teal-600"></i> å°è³‡æ™‚è–ªå¸³æœ¬
            </h1>
            <div class="flex gap-2">
                <input type="number" id="yearSelect" class="border rounded px-2 py-1 w-20 text-center font-bold focus:outline-none focus:ring-2 focus:ring-teal-300" value="2025" onchange="changeYear()">
                <select id="monthSelect" class="border rounded px-2 py-1 font-bold bg-teal-50 text-teal-700 cursor-pointer focus:outline-none focus:ring-2 focus:ring-teal-300" onchange="changeMonth()">
                    <!-- JS ç”Ÿæˆ -->
                </select>
            </div>
        </div>
        
        <div class="flex justify-between items-end border-t pt-2">
            <div class="flex space-x-2 md:space-x-6 text-sm md:text-base">
                <button onclick="switchTab('calculator')" id="btn-tab-calc" class="tab-active pb-1 px-2 transition"><i class="fas fa-edit mr-1"></i>å·¥æ™‚ç´€éŒ„</button>
                <button onclick="switchTab('report')" id="btn-tab-rep" class="pb-1 text-gray-500 hover:text-teal-600 px-2 transition"><i class="fas fa-chart-pie mr-1"></i>å¹´åº¦çµ±è¨ˆ</button>
            </div>
            <a href="https://vocus.cc/salon/WUCJ" target="_blank" class="text-teal-600 hover:text-white hover:bg-teal-500 border border-teal-200 hover:border-teal-500 px-3 py-1 rounded-full text-xs md:text-sm font-bold flex items-center transition shadow-sm">
                <i class="fas fa-rss mr-1"></i> WUCJ æ²™é¾
            </a>
        </div>
    </div>
</nav>

<div class="max-w-5xl mx-auto p-3 md:p-6">

    <!-- ================= é é¢ 1: ç•¶æœˆè©¦ç®— ================= -->
    <div id="view-calculator">
        
        <!-- å·¥å…·åˆ— -->
        <div class="flex flex-wrap gap-2 mb-4 justify-end items-center bg-white p-2 rounded shadow-sm">
            <span class="text-xs text-gray-500 mr-auto font-mono" id="currentMonthLabel">è¼‰å…¥ä¸­...</span>
            <button onclick="copySettingsToAll()" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-1 rounded text-xs transition border border-indigo-200">
                <i class="fas fa-clone mr-1"></i> è¤‡è£½è¨­å®šè‡³æ•´å¹´
            </button>
            <button onclick="toggleLock()" id="lockBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs transition border border-gray-300">
                <i class="fas fa-unlock mr-1"></i> é–å®š
            </button>
            <button onclick="clearCurrentMonth()" class="bg-red-50 hover:bg-red-100 text-red-600 px-3 py-1 rounded text-xs transition border border-red-200">
                <i class="fas fa-trash-alt mr-1"></i> æ¸…ç©ºæœ¬æœˆ
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="inputArea">
            
            <!-- Aå€: æ”¶å…¥è¨­å®š -->
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-teal-500">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                    ğŸ’° æ”¶å…¥é …ç›®
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center bg-teal-50 p-2 rounded border border-teal-100">
                        <label class="text-sm font-bold text-teal-800">ç›®å‰æ™‚è–ª (NT$)</label>
                        <input type="number" id="hourlyRate" class="input-money border-2 border-teal-300 rounded p-1 w-28 text-right text-xl focus:ring-2 ring-teal-200 outline-none text-teal-700" placeholder="190" oninput="calculate()">
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <label class="text-sm text-gray-600">å…¨å‹¤/æ¥­ç¸¾çé‡‘</label>
                        <input type="number" id="bonus" class="input-money border rounded p-1 w-28 text-right focus:ring-2 ring-yellow-200 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm text-gray-600">é¡å¤–çé‡‘ (å–®æ¬¡)</label>
                        <input type="number" id="extraBonus" class="input-money border rounded p-1 w-28 text-right focus:ring-2 ring-yellow-200 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                </div>
            </div>

            <!-- Bå€: æ‰£æ¬¾è¨­å®š -->
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-400">
                <h3 class="font-bold text-gray-800 mb-3">ğŸ’¸ æ”¯å‡º/æ‰£æ¬¾é …ç›®</h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-sm">å‹ä¿è‡ªä»˜</label>
                        <input type="number" id="deductLabor" class="input-money border rounded p-1 w-24 text-right text-red-600 focus:ring-2 ring-red-200 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm">å¥ä¿è‡ªä»˜</label>
                        <input type="number" id="deductHealth" class="input-money border rounded p-1 w-24 text-right text-red-600 focus:ring-2 ring-red-200 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm">å…¬å¸ç¦åˆ©å„²è“„</label>
                        <input type="number" id="deductSavings" class="input-money border rounded p-1 w-24 text-right text-red-600 focus:ring-2 ring-red-200 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm">åœ˜éšª/é›œè²»</label>
                        <input type="number" id="deductGroupIns" class="input-money border rounded p-1 w-24 text-right text-red-600 focus:ring-2 ring-red-200 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm text-gray-500">è«‹å‡/å…¶ä»–æ‰£é …</label>
                        <input type="number" id="deductOther" class="input-money border rounded p-1 w-24 text-right text-red-600 focus:ring-2 ring-red-200 outline-none" placeholder="0" oninput="calculate()">
                    </div>
                    
                    <div class="pt-2 text-right border-t mt-2">
                        <span class="text-xs text-gray-500 mr-2">æ‰£æ¬¾åˆè¨ˆ</span>
                        <span id="displayDeductTotal" class="font-bold font-mono text-red-600 text-lg">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cå€: æ’ç­ç´€éŒ„ -->
        <div class="bg-white p-4 rounded-lg shadow mb-32">
            <div class="flex justify-between items-center mb-3 pb-2 border-b">
                <div>
                    <h3 class="font-bold text-lg"><i class="fas fa-clock text-teal-500 mr-2"></i>å·¥æ™‚èˆ‡åŠ ç­ç´€éŒ„</h3>
                </div>
                <button onclick="addShiftRow()" class="bg-teal-600 text-white px-4 py-1.5 rounded-full text-sm hover:bg-teal-700 shadow flex items-center transition">
                    <i class="fas fa-plus mr-1"></i> ç´€éŒ„å·¥æ™‚
                </button>
            </div>

            <!-- çµ±è¨ˆå„€è¡¨ -->
            <div class="flex gap-3 mb-4 text-xs md:text-sm overflow-x-auto pb-1">
                <div class="bg-gray-100 px-3 py-1 rounded border border-gray-200 min-w-[100px]">
                    <span class="text-gray-500 block">ç¸½å·¥æ™‚</span>
                    <span class="font-bold text-gray-800 text-lg" id="totalHoursDisplay">0h</span>
                </div>
                <div class="bg-teal-50 px-3 py-1 rounded border border-teal-200 min-w-[120px]">
                    <span class="text-teal-600 block">ä¸€èˆ¬è–ªè³‡</span>
                    <span class="font-bold text-teal-700 text-lg" id="normalPayDisplay">$0</span>
                </div>
                <!-- åŠ ç­è²»å¼·èª¿é¡¯ç¤º -->
                <div class="bg-yellow-100 px-3 py-1 rounded border border-yellow-300 min-w-[120px]">
                    <span class="text-yellow-700 block font-bold"><i class="fas fa-fire mr-1"></i>åŠ ç­è²»ç¸½è¨ˆ</span>
                    <span class="font-bold text-yellow-800 text-lg" id="otPayDisplay">$0</span>
                </div>
            </div>

            <div class="overflow-x-auto min-h-[200px]">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                        <tr>
                            <th class="p-2 w-32">æ—¥æœŸ</th>
                            <th class="p-2 min-w-[160px]">é¡å‹ (åŠ ç­è²»ç‡)</th>
                            <th class="p-2 w-20 text-center">æ™‚æ•¸</th>
                            <th class="p-2 text-right">è–ªè³‡å°è¨ˆ</th>
                            <th class="p-2 w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="workList">
                        <!-- JS ç”Ÿæˆ -->
                    </tbody>
                </table>
                <div id="emptyState" class="text-center text-gray-400 py-10 hidden">
                    <i class="fas fa-clipboard-list text-4xl mb-3 text-gray-200"></i><br>
                    é»æ“Šã€Œç´€éŒ„å·¥æ™‚ã€é–‹å§‹è¼¸å…¥æ’ç­
                </div>
            </div>
        </div>

        <!-- Då€: åº•éƒ¨çµç®— Bar -->
        <div class="fixed bottom-0 left-0 w-full bg-teal-900 text-white shadow-[0_-4px_10px_rgba(0,0,0,0.2)] z-40 pb-safe">
            <div class="max-w-5xl mx-auto p-3 flex flex-row justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-[10px] text-teal-200 uppercase tracking-wider">æœ¬æœˆå¯¦é ˜ (Net Pay)</span>
                    <span class="text-3xl font-bold font-mono text-white" id="netPay">$0</span>
                </div>
                
                <div class="flex gap-4 md:gap-8 text-right">
                    <div class="hidden md:flex flex-col">
                        <span class="text-[10px] text-teal-300">ç¸½å·¥æ™‚</span>
                        <span class="text-lg font-bold" id="barTotalHours">0h</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-teal-300">æ‡‰ç™¼ç¸½é¡</span>
                        <span class="text-lg font-bold text-teal-100" id="totalGross">$0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= é é¢ 2: å¹´åº¦å ±è¡¨ ================= -->
    <div id="view-report" class="hidden">
        
        <!-- å‚™ä»½åŠŸèƒ½ -->
        <div class="flex flex-wrap justify-end gap-2 mb-4 bg-gray-100 p-2 rounded">
             <button onclick="exportYearlyExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded shadow text-sm flex items-center transition">
                <i class="fas fa-file-excel mr-2"></i> åŒ¯å‡º Excel
            </button>
            <div class="w-px bg-gray-300 mx-1"></div>
            <button onclick="exportJson()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1.5 rounded shadow text-sm flex items-center transition">
                <i class="fas fa-download mr-2"></i> å‚™ä»½
            </button>
            <label class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-1.5 rounded shadow text-sm cursor-pointer flex items-center transition">
                <i class="fas fa-upload mr-2"></i> é‚„åŸ
                <input type="file" id="importFile" class="hidden" onchange="importData(this)">
            </label>
        </div>

        <!-- å¹´åº¦å¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow border-t-4 border-teal-500">
                <div class="text-sm text-gray-500">å¹´åº¦å¯¦é ˜ç¸½é¡</div>
                <div class="text-2xl font-bold font-mono mt-1 text-gray-800" id="yearNetTotal">$0</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border-t-4 border-yellow-500">
                <div class="text-sm text-gray-500">å¹´åº¦åŠ ç­è²»ç¸½è¨ˆ</div>
                <div class="text-2xl font-bold font-mono mt-1 text-yellow-600" id="yearOtTotal">$0</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border-t-4 border-blue-500">
                <div class="text-sm text-gray-500">å¹³å‡æ™‚è–ª (å¯¦é ˜/å·¥æ™‚)</div>
                <div class="text-2xl font-bold font-mono mt-1 text-gray-800" id="yearAvgRate">$0</div>
            </div>
        </div>

        <!-- åœ–è¡¨ -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <h4 class="font-bold text-gray-700 mb-4"><i class="fas fa-chart-line mr-2"></i>æ”¶å…¥è®ŠåŒ–è¶¨å‹¢</h4>
            <canvas id="yearlyChart" height="80"></canvas>
        </div>
        
        <!-- å¹´åº¦æ˜ç´° -->
        <div class="bg-white rounded-lg shadow mb-8 overflow-hidden">
            <h4 class="font-bold text-gray-700 p-4 border-b bg-gray-50"><i class="fas fa-list mr-2"></i>æ¯æœˆè©³ç´°æ•¸æ“š (åŠ ç­è²»ç¨ç«‹é¡¯ç¤º)</h4>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-600">
                        <tr>
                            <th class="p-3 whitespace-nowrap">æœˆä»½</th>
                            <th class="p-3 text-right">ä¸€èˆ¬è–ªè³‡</th>
                            <th class="p-3 text-right text-yellow-600 font-bold bg-yellow-50">åŠ ç­è²»</th>
                            <th class="p-3 text-right text-blue-600">çé‡‘</th>
                            <th class="p-3 text-right text-red-500">æ‰£æ¬¾</th>
                            <th class="p-3 text-right font-bold text-teal-600">å¯¦é ˜é‡‘é¡</th>
                            <th class="p-3 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="yearlyTableBody">
                        <!-- JS ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å°æµ Card -->
        <div class="mt-8 bg-gradient-to-r from-teal-700 to-teal-800 text-white p-5 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h4 class="font-bold text-lg flex items-center"><i class="fas fa-lightbulb text-yellow-400 mr-2"></i> å–œæ­¡é€™å€‹å°å·¥å…·å—ï¼Ÿ</h4>
                <p class="text-sm text-teal-100 mt-1">æ­¡è¿è¨‚é–±ã€WUCJ æ²™é¾ã€‘ï¼Œç²å–æ›´å¤šå°è³‡ç†è²¡èˆ‡è¢«å‹•æ”¶å…¥çš„å¯¦ç”¨è§€é»ã€‚</p>
            </div>
            <a href="https://vocus.cc/salon/WUCJ" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-teal-900 px-6 py-2 rounded-full shadow font-bold text-sm transition transform hover:scale-105 whitespace-nowrap flex items-center border-2 border-yellow-400">
                å‰å¾€æ²™é¾ <i class="fas fa-arrow-right ml-2"></i>
            </a>
        </div>

    </div>

</div>

<script>
    // ================= æ ¸å¿ƒè¨­å®š =================
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let isLocked = false;
    const STORAGE_KEY = 'salary_pt_v2_wucj'; 
    let appData = {};

    window.onload = function() {
        const select = document.getElementById('monthSelect');
        for(let i=1; i<=12; i++) {
            let opt = document.createElement('option');
            opt.value = i;
            opt.text = i + "æœˆ";
            select.appendChild(opt);
        }
        document.getElementById('yearSelect').value = currentYear;
        select.value = currentMonth;
        loadAllData();
        loadMonthUI();
    };

    function loadAllData() {
        const json = localStorage.getItem(STORAGE_KEY);
        appData = json ? JSON.parse(json) : {};
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }

    function getMonthData(y, m) {
        if (!appData[y]) appData[y] = {};
        if (!appData[y][m]) {
            appData[y][m] = {
                hourlyRate: '190',
                bonus: '', extraBonus: '',
                deductLabor: '', deductHealth: '', 
                deductSavings: '', deductGroupIns: '', 
                deductOther: '',
                shifts: [] 
            };
        }
        return appData[y][m];
    }

    // ================= ä»‹é¢åˆ‡æ› =================
    function changeYear() {
        currentYear = document.getElementById('yearSelect').value;
        loadMonthUI();
    }
    function changeMonth() {
        currentMonth = parseInt(document.getElementById('monthSelect').value);
        loadMonthUI();
    }
    function switchTab(tab) {
        if (tab === 'calculator') {
            document.getElementById('view-calculator').classList.remove('hidden');
            document.getElementById('view-report').classList.add('hidden');
            document.getElementById('btn-tab-calc').className = 'tab-active pb-1 px-2 transition';
            document.getElementById('btn-tab-rep').className = 'pb-1 text-gray-500 hover:text-teal-600 px-2 transition';
        } else {
            document.getElementById('view-calculator').classList.add('hidden');
            document.getElementById('view-report').classList.remove('hidden');
            document.getElementById('btn-tab-calc').className = 'pb-1 text-gray-500 hover:text-teal-600 px-2 transition';
            document.getElementById('btn-tab-rep').className = 'tab-active pb-1 px-2 transition';
            updateYearlyReport();
        }
    }

    function loadMonthUI() {
        document.getElementById('currentMonthLabel').innerText = `ç·¨è¼¯ä¸­: ${currentYear}å¹´ ${currentMonth}æœˆ`;
        const data = getMonthData(currentYear, currentMonth);
        
        document.getElementById('hourlyRate').value = data.hourlyRate;
        document.getElementById('bonus').value = data.bonus;
        document.getElementById('extraBonus').value = data.extraBonus || ''; 
        
        document.getElementById('deductLabor').value = data.deductLabor;
        document.getElementById('deductHealth').value = data.deductHealth;
        document.getElementById('deductSavings').value = data.deductSavings || ''; 
        document.getElementById('deductGroupIns').value = data.deductGroupIns || ''; 
        document.getElementById('deductOther').value = data.deductOther;
        
        renderWorkTable(data.shifts);
        calculate(false);
    }

    // ================= è¨ˆç®—å¼•æ“ =================
    function calculate(shouldSave = true) {
        const rate = parseFloat(document.getElementById('hourlyRate').value) || 0;
        const bonus = parseFloat(document.getElementById('bonus').value) || 0;
        const extraBonus = parseFloat(document.getElementById('extraBonus').value) || 0;
        
        const data = getMonthData(currentYear, currentMonth);
        
        let totalHours = 0;
        let normalIncome = 0;
        let otIncome = 0;

        data.shifts.forEach(item => {
            const h = parseFloat(item.hours) || 0;
            totalHours += h;
            
            let pay = 0;
            if (item.type === 'normal') {
                pay = h * rate;
                normalIncome += pay;
            } else if (item.type === 'ot_134') {
                pay = h * rate * 1.34; 
                otIncome += pay;
            } else if (item.type === 'ot_167') {
                pay = h * rate * 1.67;
                otIncome += pay;
            } else if (item.type === 'ot_200') {
                pay = h * rate * 2;
                otIncome += pay;
            }
            item.pay = pay;
        });

        data.shifts.forEach((item, idx) => {
            const el = document.getElementById(`shift-pay-${idx}`);
            if(el) el.innerText = Math.round(item.pay);
        });

        const dLabor = parseFloat(document.getElementById('deductLabor').value) || 0;
        const dHealth = parseFloat(document.getElementById('deductHealth').value) || 0;
        const dSavings = parseFloat(document.getElementById('deductSavings').value) || 0;
        const dGroupIns = parseFloat(document.getElementById('deductGroupIns').value) || 0;
        const dOther = parseFloat(document.getElementById('deductOther').value) || 0;
        
        const totalDeduct = dLabor + dHealth + dSavings + dGroupIns + dOther;
        
        document.getElementById('displayDeductTotal').innerText = totalDeduct.toLocaleString();

        const totalGross = normalIncome + otIncome + bonus + extraBonus;
        const netPay = totalGross - totalDeduct;

        document.getElementById('totalHoursDisplay').innerText = totalHours.toFixed(1) + 'h';
        document.getElementById('normalPayDisplay').innerText = '$' + Math.round(normalIncome).toLocaleString();
        document.getElementById('otPayDisplay').innerText = '$' + Math.round(otIncome).toLocaleString();

        document.getElementById('barTotalHours').innerText = totalHours.toFixed(1) + 'h';
        document.getElementById('totalGross').innerText = '$' + Math.round(totalGross).toLocaleString();
        document.getElementById('netPay').innerText = '$' + Math.round(netPay).toLocaleString();

        if (shouldSave) {
            data.hourlyRate = document.getElementById('hourlyRate').value;
            data.bonus = document.getElementById('bonus').value;
            data.extraBonus = document.getElementById('extraBonus').value;
            data.deductLabor = document.getElementById('deductLabor').value;
            data.deductHealth = document.getElementById('deductHealth').value;
            data.deductSavings = document.getElementById('deductSavings').value;
            data.deductGroupIns = document.getElementById('deductGroupIns').value;
            data.deductOther = document.getElementById('deductOther').value;
            saveData();
        }
    }

    // ================= è¡¨æ ¼æ“ä½œ =================
    function renderWorkTable(list) {
        const tbody = document.getElementById('workList');
        const emptyState = document.getElementById('emptyState');
        tbody.innerHTML = '';
        
        if (!list || list.length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }
        emptyState.classList.add('hidden');

        list.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.className = "border-b hover:bg-gray-50 transition";
            
            let selectClass = "font-bold text-gray-700";
            if(item.type.includes('ot')) selectClass = "font-bold text-orange-600";
            if(item.type === 'ot_200') selectClass = "font-bold text-red-600";

            tr.innerHTML = `
                <td class="p-2"><input type="date" value="${item.date}" onchange="updateShift(${index}, 'date', this.value)" class="border rounded px-2 py-1 w-full text-xs bg-white"></td>
                <td class="p-2">
                    <select onchange="updateShift(${index}, 'type', this.value)" class="border rounded px-2 py-1 w-full text-xs bg-white ${selectClass}">
                        <option value="normal" ${item.type === 'normal' ? 'selected' : ''}>ä¸€èˆ¬å·¥æ™‚ (1.0)</option>
                        <option value="ot_134" ${item.type === 'ot_134' ? 'selected' : ''}>åŠ ç­/ä¼‘æ¯æ—¥ (1.34)</option>
                        <option value="ot_167" ${item.type === 'ot_167' ? 'selected' : ''}>åŠ ç­å¾Œæ®µ (1.67)</option>
                        <option value="ot_200" ${item.type === 'ot_200' ? 'selected' : ''}>åœ‹å®šå‡æ—¥ (2.0)</option>
                    </select>
                </td>
                <td class="p-2"><input type="number" value="${item.hours}" oninput="updateShift(${index}, 'hours', this.value)" class="border rounded px-2 py-1 w-16 text-xs text-center font-bold" placeholder="0"></td>
                <td class="p-2 text-right font-mono text-teal-600 font-bold" id="shift-pay-${index}">${Math.round(item.pay || 0)}</td>
                <td class="p-2 text-center"><button onclick="removeShift(${index})" class="text-gray-400 hover:text-red-500"><i class="fas fa-times-circle"></i></button></td>
            `;
            tbody.appendChild(tr);
        });
        
        if (isLocked) {
             tbody.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
        }
    }

    function addShiftRow() {
        if(isLocked) return;
        const data = getMonthData(currentYear, currentMonth);
        let defaultDate = new Date().toISOString().slice(0,10);
        if(data.shifts.length > 0) defaultDate = data.shifts[data.shifts.length-1].date;

        data.shifts.push({ date: defaultDate, type: 'normal', hours: 4, pay: 0 }); 
        renderWorkTable(data.shifts);
        calculate();
    }
    function removeShift(index) {
        if(isLocked) return;
        const data = getMonthData(currentYear, currentMonth);
        data.shifts.splice(index, 1);
        renderWorkTable(data.shifts);
        calculate();
    }
    function updateShift(index, field, val) {
        const data = getMonthData(currentYear, currentMonth);
        data.shifts[index][field] = val;
        if(field === 'type') renderWorkTable(data.shifts);
        calculate();
    }

    // ================= åŠŸèƒ½æ“ä½œ =================
    function copySettingsToAll() {
        if(!confirm(`è¦å°‡ ${currentMonth} æœˆçš„ã€Œæ™‚è–ªã€å„é …æ‰£æ¬¾ã€è¨­å®šè¤‡è£½åˆ°æ•´å¹´å—ï¼Ÿ`)) return;
        const src = getMonthData(currentYear, currentMonth);
        for(let i=1; i<=12; i++) {
            if (i === currentMonth) continue;
            let target = getMonthData(currentYear, i);
            target.hourlyRate = src.hourlyRate;
            target.deductLabor = src.deductLabor;
            target.deductHealth = src.deductHealth;
            target.deductSavings = src.deductSavings;
            target.deductGroupIns = src.deductGroupIns;
        }
        saveData();
        alert("è¨­å®šå·²è¤‡è£½ï¼");
    }

    function clearCurrentMonth() {
        if(!confirm("ç¢ºå®šæ¸…ç©ºæœ¬æœˆæ‰€æœ‰è³‡æ–™ï¼Ÿ")) return;
        const data = getMonthData(currentYear, currentMonth);
        data.hourlyRate = '190'; data.bonus = ''; data.extraBonus = '';
        data.deductLabor = ''; data.deductHealth = ''; data.deductSavings = ''; data.deductGroupIns = ''; data.deductOther = '';
        data.shifts = [];
        saveData();
        loadMonthUI();
    }

    function toggleLock() {
        isLocked = !isLocked;
        const btn = document.getElementById('lockBtn');
        const inputArea = document.getElementById('inputArea');
        const workList = document.getElementById('workList');
        
        if(isLocked) {
            btn.innerHTML = '<i class="fas fa-lock text-red-500 mr-1"></i> è§£é–';
            inputArea.classList.add('locked');
            workList.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
        } else {
            btn.innerHTML = '<i class="fas fa-unlock mr-1"></i> é–å®š';
            inputArea.classList.remove('locked');
            workList.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
        }
    }

    // ================= å¹´åº¦å ±è¡¨ (å¼·åŒ–åŠ ç­é¡¯ç¤º) =================
    let chartInstance = null;
    function updateYearlyReport() {
        let labels = [];
        let nets = [];
        let hoursData = [];
        let stats = [];
        
        let sumNet = 0; let sumHours = 0; let sumOtPay = 0;

        for(let i=1; i<=12; i++) {
            const d = appData[currentYear]?.[i];
            const rate = parseFloat(d?.hourlyRate)||0;
            const bonus = parseFloat(d?.bonus)||0;
            const extra = parseFloat(d?.extraBonus)||0; 
            
            let monthRegPay = 0;
            let monthOtPay = 0;
            let monthHours = 0;
            
            if(d?.shifts) {
                d.shifts.forEach(s => {
                    let h = parseFloat(s.hours)||0;
                    monthHours += h;
                    let p = 0;
                    if(s.type==='normal') {
                        p = h * rate;
                        monthRegPay += p;
                    } else {
                        // æ‰€æœ‰åŠ ç­é¡å‹
                        if(s.type==='ot_134') p = h * rate * 1.34;
                        else if(s.type==='ot_167') p = h * rate * 1.67;
                        else if(s.type==='ot_200') p = h * rate * 2;
                        monthOtPay += p;
                    }
                });
            }

            const ded = (parseFloat(d?.deductLabor)||0) + 
                        (parseFloat(d?.deductHealth)||0) + 
                        (parseFloat(d?.deductSavings)||0) + 
                        (parseFloat(d?.deductGroupIns)||0) + 
                        (parseFloat(d?.deductOther)||0);
            
            const totalBonuses = bonus + extra;
            const net = monthRegPay + monthOtPay + totalBonuses - ded;
            
            sumNet += net; 
            sumHours += monthHours;
            sumOtPay += monthOtPay;
            
            labels.push(i + 'æœˆ');
            nets.push(net);
            hoursData.push(monthHours);
            
            if (monthRegPay + monthOtPay + totalBonuses > 0) { 
                stats.push({ 
                    m: i, 
                    hours: monthHours, 
                    regPay: monthRegPay, 
                    otPay: monthOtPay,
                    bonuses: totalBonuses,
                    ded: ded, 
                    net: net 
                });
            }
        }

        document.getElementById('yearNetTotal').innerText = "$" + Math.round(sumNet).toLocaleString();
        document.getElementById('yearOtTotal').innerText = "$" + Math.round(sumOtPay).toLocaleString();
        let avg = sumHours > 0 ? Math.round(sumNet / sumHours) : 0;
        document.getElementById('yearAvgRate').innerText = "$" + avg + "/h";

        // Chart
        const ctx = document.getElementById('yearlyChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'å¯¦é ˜é‡‘é¡', data: nets, backgroundColor: '#0d9488', borderRadius: 4, order: 2 },
                    { label: 'å·¥æ™‚ (å°æ™‚)', data: hoursData, type: 'line', borderColor: '#eab308', borderWidth: 2, yAxisID: 'y1', order: 1 }
                ]
            },
            options: { 
                responsive: true, 
                scales: { 
                    y: { beginAtZero: true },
                    y1: { position: 'right', grid: { drawOnChartArea: false } }
                } 
            }
        });
        
        // Table - å¢åŠ åŠ ç­è²»æ¬„ä½
        const tbody = document.getElementById('yearlyTableBody');
        tbody.innerHTML = '';
        if (stats.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œè«‹å…ˆè‡³ã€Œå·¥æ™‚ç´€éŒ„ã€è¼¸å…¥ã€‚</td></tr>';
        } else {
            stats.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="p-3 text-center font-bold">${s.m}æœˆ</td>
                    <td class="p-3 text-right text-gray-800">${Math.round(s.regPay).toLocaleString()}</td>
                    <td class="p-3 text-right text-yellow-700 font-bold bg-yellow-50">${s.otPay > 0 ? Math.round(s.otPay).toLocaleString() : '-'}</td>
                    <td class="p-3 text-right text-blue-600">${s.bonuses > 0 ? s.bonuses.toLocaleString() : '-'}</td>
                    <td class="p-3 text-right text-red-400">${s.ded > 0 ? '-' + s.ded.toLocaleString() : '-'}</td>
                    <td class="p-3 text-right font-bold text-teal-600">${Math.round(s.net).toLocaleString()}</td>
                    <td class="p-3 text-center">
                        <button onclick="jumpToMonth(${s.m})" class="text-teal-500 hover:text-teal-700 text-xs border border-teal-200 rounded px-2 py-1">ç·¨è¼¯</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    function jumpToMonth(m) {
        document.getElementById('monthSelect').value = m;
        changeMonth();
        switchTab('calculator');
    }

    // ================= æª”æ¡ˆè™•ç† (Excel / JSON) =================
    function exportYearlyExcel() {
        const wb = XLSX.utils.book_new();
        // æ›´æ–° Excel æ¨™é¡Œï¼Œæ‹†åˆ†ä¸€èˆ¬å·¥æ™‚èˆ‡åŠ ç­å·¥æ™‚
        let wsData = [
            ["å¹´åº¦æ™‚è–ª/åŠ ç­è²»è©³ç´°å ±è¡¨", currentYear + "å¹´"],
            ["æœˆä»½", "è¨­å®šæ™‚è–ª", "ä¸€èˆ¬å·¥æ™‚", "åŠ ç­å·¥æ™‚", "ä¸€èˆ¬è–ªè³‡", "åŠ ç­è²»", "å›ºå®šçé‡‘", "é¡å¤–çé‡‘", "å‹ä¿", "å¥ä¿", "ç¦åˆ©å„²è“„", "åœ˜éšª/é›œè²»", "å…¶ä»–æ‰£é …", "å¯¦é ˜é‡‘é¡"]
        ];

        for(let i=1; i<=12; i++) {
            const d = appData[currentYear]?.[i];
            if(d) {
                const rate = d.hourlyRate;
                const bonus = parseFloat(d.bonus)||0;
                const extra = parseFloat(d.extraBonus)||0;
                
                let regHours = 0;
                let otHours = 0;
                let regPay = 0;
                let otPay = 0;
                
                if(d.shifts) {
                    d.shifts.forEach(s => {
                        let h = parseFloat(s.hours)||0;
                        if(s.type==='normal') {
                            regHours += h;
                            regPay += h * rate;
                        } else {
                            otHours += h;
                            if(s.type==='ot_134') otPay += h * rate * 1.34;
                            else if(s.type==='ot_167') otPay += h * rate * 1.67;
                            else if(s.type==='ot_200') otPay += h * rate * 2;
                        }
                    });
                }
                
                const dLabor = parseFloat(d.deductLabor)||0;
                const dHealth = parseFloat(d.deductHealth)||0;
                const dSavings = parseFloat(d.deductSavings)||0;
                const dGroupIns = parseFloat(d.deductGroupIns)||0;
                const dOther = parseFloat(d.deductOther)||0;
                
                const totalDed = dLabor + dHealth + dSavings + dGroupIns + dOther;
                const net = regPay + otPay + bonus + extra - totalDed;
                
                wsData.push([
                    i, rate, 
                    regHours, otHours, 
                    Math.round(regPay), Math.round(otPay), 
                    bonus, extra, 
                    dLabor, dHealth, dSavings, dGroupIns, dOther, 
                    Math.round(net)
                ]);
            }
        }
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "å¹´åº¦è©³ç´°å ±è¡¨");
        XLSX.writeFile(wb, `Salary_Detail_Report_${currentYear}.xlsx`);
    }

    function exportJson() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `PT_Backup_${currentYear}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const raw = JSON.parse(e.target.result);
                if (typeof raw === 'object') {
                    appData = raw;
                    saveData();
                    alert("åŒ¯å…¥æˆåŠŸï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚");
                    location.reload();
                } else { alert("æ ¼å¼éŒ¯èª¤"); }
            } catch (err) { alert("æª”æ¡ˆææ¯€"); }
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>
